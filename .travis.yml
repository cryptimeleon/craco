language: java

jdk:
- openjdk8

before_cache:
- rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
- rm -fr $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
  - "$HOME/.gradle/caches/"
  - "$HOME/.gradle/wrapper/"

stages:
- name: build
- name: release
  if: branch = release

before_script:
  git checkout ${TRAVIS_BRANCH} # to fix travis checking out HEAD branch which breaks grgit

jobs:
  include:
  - stage: build
    before_install:
      git checkout ${TRAVIS_BRANCH} # to fix travis checking out HEAD branch (breaks grgit)
    install: ./gradlew assemble -PcheckoutIfCloned=true
    script: ./gradlew check -PcheckoutIfCloned=true
  - stage: release
    script: ./gradlew publish -Ddisablesnapshot=true -Dnexus.user=$NEXUS_USER -Dnexus.key=$NEXUS_KEY
      -Dbuild.number=$TRAVIS_BUILD_NUMBER

deploy:
  provider: releases
  api_key:
    secure: hi62cv1hYPi6S8ii1PI3C9EpTnrgB/06rO+uFsPGJQeQvJIkP5fJ07wDhih+wqlA81T4QE6xtqTddn/i6QquorzGDHv9MoO7l42kedyXgAEMqcuw90do6cRMGChpz66VqQvFUaE+6qzn46HwasB2SxN0U8OmUUKBiz142o51zNPI0D+oOeErEGhqmsKq71npK/YlLIWyFEHaoxTq6vn+zynFatJ0d4eD/fbrVDvl+8CGVNuXscGrSqvszkAUl0yFOXli7zh3aCkQYm6nXzJUNL7Q5GTfcfCC/gkY5ugYBfst16d7mGydyxrI6i5+NhuwDgPSJ3x4MuGgMrc6fX00AEEPnNsvkRmb2P8NVZNruWihUF4ir/pov1GgElgIPFsiS+NCT/EbLTnmlxnqDrJM4dYET5s7QkR07V1sNAjBnRhXgzu0ZKvXtN+n7RktriOmV4BW3nHGHlbp2P50c2h4ItZcbrJRd79ZuTSLBKpgcYiulgG5zN8qWYTsnmA/XIBI+hH2wM2M5PRjiyyvifoDJSgPRAngjj2o6YMct+J/jpAB8NhlaM4VUZT2dtkfk1UMO5AvRxx5xeVs5vnrNatg7FyswcGQQZE/YYBOaP3JRqrvVHCbWz/kLSfxXL9OLmQ8KyYkZzXgG8t/wBPnhtzoNLOanw6anE6qaWTM1EhX4MM=
  file_glob: true
  file: build/libs/*
  skip_cleanup: true
  on:
    repo: upbcuk/upb.crypto.craco
    branch: release
